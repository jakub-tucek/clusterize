#!/bin/bash
#PBS -N {{general.taskName}}
#PBS -l walltime={{resources.walltime}}
#PBS -l {{{resources.formattedResources}}}
{{#resources.toolboxes}}#PBS -l {{.}}=1
{{/resources.toolboxes}}
#PBS -o {{runPath}}/{{fileNames.stdOutLog}}
#PBS -e {{runPath}}/{{fileNames.stdErrLog}}

# Print start time
echo "{{jobInfoProps.start}}: "`date --utc +%FT%T` > {{runPath}}/{{fileNames.jobInfo}}
# Print JOB PID to folder
echo "{{jobInfoProps.pid}}: $PBS_JOBID" >> {{runPath}}/{{fileNames.jobInfo}}

{{#resources.modules}}module add {{.}} # loads desired application
{{/resources.modules}}

DATADIR="{{storagePath}}" # sets up your input data directory


{{#variables}}export {{first}}="{{second}}"
{{/variables}}

{{#general.dependents}}export {{name}}=$(({{dependentVarName}}{{modifier}}))
{{/general.dependents}}

export MATLAB_DIR="{{sourcesPath}}"
export IN_DIR="{{sourcesPath}}"
export OUT_DIR="{{runPath}}"
export MATLAB_THREADS="{{resources.ncpus}}"

# execute Matlab command
# Parallel Computing Toolbox requires JVM !!!!!!!!
matlab -nodesktop -nosplash -nodisplay -r            \
"try,                                               "\
"    maxNumCompThreads($MATLAB_THREADS);,           "\
"    addpath('$MATLAB_DIR'),                        "\
"    {{{taskType.functionCall}}}, "\
"catch e,                                           "\
"    disp(getReport(e)),                            "\
"    exit(1),                                       "\
"end,                                               "\
"exit(0)"                                            \
&> "{{runPath}}/{{fileNames.stdJobLog}}"

# Print finish date
echo "{{jobInfoProps.end}}: "`date --utc +%FT%T` >> {{runPath}}/{{fileNames.jobInfo}}
# Print status
echo "{{jobInfoProps.status}}: "$? >> {{runPath}}/{{fileNames.jobInfo}}
